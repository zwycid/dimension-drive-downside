package lk.summer.project.background;

import java.util.Random;

import lk.summer.project.background.BackgroundSurfaceView;
import lk.summer.project.lkcustom.LKAndroid;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Canvas;
import android.graphics.Paint;
import android.graphics.Point;
import android.graphics.Rect;
import android.view.SurfaceHolder;

public class LKThreadFallingText extends Thread implements Runnable {

	private Random random;
	private Paint paint;
	private BackgroundSurfaceView bgSurfaceView;

	public BackgroundSurfaceView getBgSurfaceiew() {		return bgSurfaceView;	}
	public void setBgSurfaceiew(BackgroundSurfaceView bgSurfaceView) {		bgSurfaceView = bgSurfaceView;	}

	private int[] text_speed_x;
	private int[] text_speed_y;
	private Point[] text_pt;
	
	private SurfaceHolder holder;
	private Canvas canvas;
	
	public Random getRandom() {		return random;	}
	public void setRandom(Random random) {		this.random = random;	}
	public Paint getPaint() {		return paint;	}
	public void setPaint(Paint paint) {		this.paint = paint;	}
	public int[] getText_speed_x() {		return text_speed_x;	}
	public void setText_speed_x(int[] text_speed_x) {		this.text_speed_x = text_speed_x;	}
	public int[] getText_speed_y() {		return text_speed_y;	}
	public void setText_speed_y(int[] text_speed_y) {		this.text_speed_y = text_speed_y;	}
	public Point[] getText_pt() {		return text_pt;	}
	public void setText_pt(Point[] text_pt) {		this.text_pt = text_pt;	}
	public SurfaceHolder getHolder() {		return holder;	}
	public void setHolder(SurfaceHolder holder) {		this.holder = holder;	}
	public Canvas getCanvas() {		return canvas;	}
	public void setCanvas(Canvas canvas) {		this.canvas = canvas;	}

	public void run() {
		random			= new Random();
		paint				= new Paint();

		text_speed_x		= new int[bgSurfaceView.getTextImageArray().length];
		text_speed_y		= new int[bgSurfaceView.getTextImageArray().length];
		text_pt			= new Point[bgSurfaceView.getTextImageArray().length];
		
		holder	= this.getHolder();
		//src는 원래 이미지의 크기, dest는 실제 그릴 그림의 크기입니다.

		for(int i = 0 ; i < bgSurfaceView.getTextImageArray().length ; i++){
			//일단 겹침 없이 출력되는 걸로
			text_speed_x[i]	= (bgSurfaceView.getWidth() / bgSurfaceView.THE_NUMBER_OF_FALLING_TEXT) * i;
			text_speed_y[i]	= Math.abs(random.nextInt() % bgSurfaceView.FALLING_TEXT_MAX_SPEED) + bgSurfaceView.FALLING_TEXT_MIN_SPEED;

			text_pt[i]	= new Point(text_speed_x[i], -1 * bgSurfaceView.getTextHeightArray()[i]);
		}

		Bitmap background	= BitmapFactory.decodeResource(bgSurfaceView.getResources(),LKAndroid.getID("drawable", "blackimage"));
		Rect rectangleForBGI	= new Rect(0, 0, bgSurfaceView.getWidth(), bgSurfaceView.getHeight());

		while(this != null){
			//double buffering
			//allocate canvas of holder to variable canvas
			canvas	= holder.lockCanvas();
			canvas.drawBitmap(background, null, rectangleForBGI, null);

			for(int i = 0 ; i < bgSurfaceView.getTextImageArray().length ; i++)
				canvas.drawBitmap(bgSurfaceView.getTextImageArray()[i], text_pt[i].x, text_pt[i].y, paint);

			//완료된 화변 canvas를 현재 화면(holder)에 할당
			holder.unlockCanvasAndPost(canvas);

			for(int i = 0 ; i != bgSurfaceView.getTextImageArray().length ; i++){
				if(text_pt[i].y > bgSurfaceView.getHeight())
					text_pt[i].y	= -1 * bgSurfaceView.getTextHeightArray()[i];
				text_pt[i].y	+= text_speed_y[i];
			}
		}
	}
	
	public void initialize(){
		
	}

	public LKThreadFallingText(Runnable runnable, BackgroundSurfaceView backgroundSurfaceView) {
		super(runnable);
		setBgSurfaceiew(backgroundSurfaceView);
	}
}
